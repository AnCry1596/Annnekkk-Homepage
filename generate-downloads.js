const fs = require('fs');
const path = require('path');

/**
 * Script to automatically scan the downloads folder and generate
 * a configuration file with actual file sizes
 *
 * Run this script whenever you add new versions:
 * node generate-downloads.js
 */

const DOWNLOADS_DIR = path.join(__dirname, 'downloads');
const OUTPUT_FILE = path.join(__dirname, 'js', 'downloads-data.js');

// Configuration for apps and platforms
const config = {
    apps: [
        { name: 'CCN Checker', prefix: 'ccn-Checker', iconColor: '#cba6f7' },
        { name: 'CVV Checker', prefix: 'cvv-Checker', iconColor: '#f5c2e7' }
    ],
    platforms: [
        { name: 'Windows x64', suffix: 'windows-x64.exe', description: 'For 64-bit Windows systems', icon: 'windows' },
        { name: 'Windows ARM64', suffix: 'windows-arm64.exe', description: 'For ARM64 Windows systems', icon: 'windows' },
        { name: 'macOS ARM64', suffix: 'macos-arm64.dmg', description: 'For Apple Silicon (M1/M2/M3)', icon: 'macos' },
        { name: 'macOS x64', suffix: 'macos-x64.dmg', description: 'For Intel-based Macs', icon: 'macos' },
        { name: 'Linux x64', suffix: 'linux-x64', description: 'For 64-bit Linux systems', icon: 'linux' }
    ]
};

// Get file size
function getFileSize(filePath) {
    try {
        const stats = fs.statSync(filePath);
        return stats.size;
    } catch (err) {
        console.warn(`Warning: Could not get size for ${filePath}`);
        return 0;
    }
}

// Extract version from folder name (e.g., "V2.0.1" -> "2.0.1")
function extractVersion(folderName) {
    return folderName.replace(/^V/, '');
}

// Scan downloads directory
function scanDownloads() {
    if (!fs.existsSync(DOWNLOADS_DIR)) {
        console.error(`Error: Downloads directory not found at ${DOWNLOADS_DIR}`);
        process.exit(1);
    }

    const versionFolders = fs.readdirSync(DOWNLOADS_DIR)
        .filter(item => {
            const itemPath = path.join(DOWNLOADS_DIR, item);
            return fs.statSync(itemPath).isDirectory() && item.match(/^V\d+\.\d+\.\d+$/);
        })
        .sort((a, b) => {
            // Sort versions in descending order (newest first)
            const versionA = extractVersion(a).split('.').map(Number);
            const versionB = extractVersion(b).split('.').map(Number);

            for (let i = 0; i < 3; i++) {
                if (versionB[i] !== versionA[i]) {
                    return versionB[i] - versionA[i];
                }
            }
            return 0;
        });

    if (versionFolders.length === 0) {
        console.error('Error: No version folders found in downloads directory');
        process.exit(1);
    }

    console.log(`Found ${versionFolders.length} version(s): ${versionFolders.join(', ')}`);

    const versions = versionFolders.map((folder, index) => {
        const version = extractVersion(folder);
        const versionPath = path.join(DOWNLOADS_DIR, folder);
        const isLatest = index === 0; // First item is latest due to sort

        console.log(`\nScanning version ${version}...`);

        const apps = config.apps.map(app => {
            const files = {};

            config.platforms.forEach(platform => {
                const fileName = `${version}-stable-${app.prefix}-by-annnekkk-${platform.suffix}`;
                const filePath = path.join(versionPath, fileName);
                const fileSize = getFileSize(filePath);

                if (fileSize > 0) {
                    files[platform.suffix] = fileSize;
                    console.log(`  ✓ ${fileName} (${formatBytes(fileSize)})`);
                } else {
                    console.log(`  ✗ ${fileName} (not found)`);
                }
            });

            return {
                name: app.name,
                prefix: app.prefix,
                iconColor: app.iconColor,
                files: files
            };
        });

        return {
            version: version,
            isLatest: isLatest,
            apps: apps
        };
    });

    return {
        versions: versions,
        platforms: config.platforms
    };
}

// Format bytes to human readable
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Main execution
try {
    console.log('Scanning downloads folder...\n');
    const data = scanDownloads();

    // Ensure js directory exists
    const jsDir = path.dirname(OUTPUT_FILE);
    if (!fs.existsSync(jsDir)) {
        fs.mkdirSync(jsDir, { recursive: true });
    }

    // Write to file as JavaScript module
    const jsContent = `// This file is auto-generated by generate-downloads.js
// Do not edit manually - run: node generate-downloads.js

const downloadsData = ${JSON.stringify(data, null, 2)};
`;

    fs.writeFileSync(OUTPUT_FILE, jsContent);

    console.log(`\n✓ Successfully generated ${OUTPUT_FILE}`);
    console.log(`  Total versions: ${data.versions.length}`);
    console.log(`  Latest version: ${data.versions[0].version}`);
} catch (err) {
    console.error('Error:', err.message);
    process.exit(1);
}
